from umg.airflow_dag import DagConfigfrom datetime import datetime, timedeltafrom airflow import modelsfrom umg.util import rest_api_client,on_job_finish, is_file_unavailable_notifyfrom umg.operator.gcp_bq_ops import UMGBigQueryOperatorfrom umg.operator.sh_ops import UmgBashOperatorfrom umg.lineage.dataset import *from airflow.operators.bash import BashOperatorfrom airflow.models import Variablefrom airflow.operators.python_operator import ShortCircuitOperatorfrom airflow.operators.python import PythonOperatorfrom airflow.operators.dummy import DummyOperatorclass SQLTemplatedPythonOperator(PythonOperator):    template_ext = ('.sql','.bql')config = DagConfig('@project.artifactId@', '@dag.version@')products_for_collection_config = config.get('products_for_collection_config')vaultRole = config.get("shopify_vault_public_role")vaultShopifyPath = config.get('shopify_vault_public_path')vaultServiceAccount = config.get('shopify_vault_public_service_account')default_args = {    'owner': 'Jyothi Gandham',    'depends_on_past': False,    'start_date': datetime(2024, 9, 2),    'email': config.get('notification_email'),    'email_on_failure': config.get('email_on_failure'),    'email_on_retry': False,    'retries': 1,    'retry_delay': timedelta(minutes=5),    'dataflow_default_options': {        'region': config.get('df-region'),        'project': config.get('workflow_project'),        'tempLocation': '{}shopify/dataflow/tmp/'.format(config.get('temp_bucket')),        'gcpTempLocation': '{}shopify/dataflow/tmp/'.format(config.get('temp_bucket')),        'autoscalingAlgorithm': 'THROUGHPUT_BASED',        'serviceAccount': config.get('df-service-account')    }}with models.DAG(        config.dag_name('batch_daily_jp'),        catchup=False,        max_active_runs=2,        tags=["shopify", "ecomm"],        schedule_interval= None if config.get('schedule_interval')['daily_jp'] == 'None' else config.get('schedule_interval')['daily_jp'],        default_args=default_args) as dag:    def skip_check(templates_dict,**kwargs):        date_ds=templates_dict['date_ds']        date = datetime.strptime(date_ds, '%Y-%m-%d')        weekday = datetime.weekday(date)        if weekday == 5 or weekday == 6 :            return False        else:            return True            skip_check = ShortCircuitOperator(                      task_id='skip-check-weekend',                      provide_context=True,                      python_callable=skip_check,                      trigger_rule='all_success',                      templates_dict={                            'date_ds' : '{{ds}}'                      },                      dag=dag)    email_sql = \        "select notification_emails from `{email_project}.shopify_validation.report_notification_emails` where report_name = '{report_name}'limit 1".format(email_project=config.get('shopify_report_project'                                                                                                                                                                                     ), report_name=config.get('report_name'))    download_batch_1 = rest_api_client(        dataset_type=DatasetType.fact,        task_id=config.task_name('download-shopify-1'),        gcp_conn_id='google_cloud_default',        jar=config.remote_repo() + 'com/umusic/data/datalake/elt/shopify/shopify-ingestion/{version}/shopify-ingestion-{version}-dataflow.jar'.format(            version=config.get('version')),        job_class='com.umusic.datalake.elt.shopify.ingestion.dataflow.Scraper',        options={            'labels': config.labels(),            'inputPath': '',            'outputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch1/',            'startDate': '{{ds}}',            'endDate': '{{tomorrow_ds}}',            'workerMachineType': 'n1-standard-2',            'numWorkers': '3',            'maxNumWorkers': '8',            'vaultUrl': config.get("central_vault_host"),            'vaultRole': vaultRole,            'vaultShopifyPath': vaultShopifyPath,            'apisToSkip': config.get('shopify_apis_to_skip'),            'reportPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch1/report/',            'frequency': 'daily',            'apiVersion': "{{var.value.shopify_api_version}}",            'vaultServiceAccount': vaultServiceAccount,            'BQSyncFlag': config.get('batch_daily_BQSyncFlag'),            'domainRegion':'JP',            "vaultFlag": config.get("vault_flag")["batch_daily_jp"],            "enterpriseVaultUrl": config.get("enterprise_vault_url"),            "enterpriseVaultPath": config.get("enterprise_vault_path"),            "enterpriseVaultRole": config.get("enterprise_vault_role"),            "enterpriseVaultNamespace": config.get("enterprise_vault_namespace"),            "enterpriseVaultServiceAccount": config.get("enterprise_vault_service_account")        },        retries=5,        dag=dag)    download_batch_2 = rest_api_client(        dataset_type=DatasetType.fact,        task_id=config.task_name('download-shopify-2'),        gcp_conn_id='google_cloud_default',        jar=config.remote_repo() + 'com/umusic/data/datalake/elt/shopify/shopify-ingestion/{version}/shopify-ingestion-{version}-dataflow.jar'.format(            version=config.get('version')),        job_class='com.umusic.datalake.elt.shopify.ingestion.dataflow.Scraper',        options={            'labels': config.labels(),            'inputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch1/next_batch/*',            'outputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch2/',            'startDate': '{{ds}}',            'endDate': '{{tomorrow_ds}}',            'workerMachineType': 'n1-standard-2',            'numWorkers': '3',            'maxNumWorkers': '6',            'vaultUrl': config.get("central_vault_host"),            'vaultRole': vaultRole,            'vaultShopifyPath': vaultShopifyPath,            'apisToSkip': config.get('shopify_apis_to_skip'),            'reportPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch2/report/',            'frequency': 'daily',            'apiVersion': "{{var.value.shopify_api_version}}",            'vaultServiceAccount': vaultServiceAccount,            'BQSyncFlag': config.get('batch_daily_BQSyncFlag'),            'domainRegion':'JP',            "vaultFlag": config.get("vault_flag")["batch_daily_jp"],            "enterpriseVaultUrl": config.get("enterprise_vault_url"),            "enterpriseVaultPath": config.get("enterprise_vault_path"),            "enterpriseVaultRole": config.get("enterprise_vault_role"),            "enterpriseVaultNamespace": config.get("enterprise_vault_namespace"),            "enterpriseVaultServiceAccount": config.get("enterprise_vault_service_account")        },        retries=5,        dag=dag)    download_batch_3 = rest_api_client(        dataset_type=DatasetType.fact,        task_id=config.task_name('download-shopify-3'),        gcp_conn_id='google_cloud_default',        jar=config.remote_repo() + 'com/umusic/data/datalake/elt/shopify/shopify-ingestion/{version}/shopify-ingestion-{version}-dataflow.jar'.format(            version=config.get('version')),        job_class='com.umusic.datalake.elt.shopify.ingestion.dataflow.Scraper',        options={            'labels': config.labels(),            'inputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch2/next_batch/*',            'outputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch3/',            'startDate': '{{ds}}',            'endDate': '{{tomorrow_ds}}',            'workerMachineType': 'n1-standard-2',            'numWorkers': '3',            'maxNumWorkers': '6',            'vaultUrl': config.get("central_vault_host"),            'vaultRole': vaultRole,            'vaultShopifyPath': vaultShopifyPath,            'apisToSkip': config.get('shopify_apis_to_skip'),            'reportPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_jp_0/report_date={{ds_nodash}}/batch3/report/',            'apiVersion': "{{var.value.shopify_api_version}}",            'vaultServiceAccount': vaultServiceAccount,            'BQSyncFlag': config.get('batch_daily_BQSyncFlag'),            'domainRegion':'JP',            "vaultFlag": config.get("vault_flag")["batch_daily_jp"],            "enterpriseVaultUrl": config.get("enterprise_vault_url"),            "enterpriseVaultPath": config.get("enterprise_vault_path"),            "enterpriseVaultRole": config.get("enterprise_vault_role"),            "enterpriseVaultNamespace": config.get("enterprise_vault_namespace"),            "enterpriseVaultServiceAccount": config.get("enterprise_vault_service_account")        },        retries=5,        dag=dag)    # download_batch_4 = rest_api_client(    #     dataset_type=DatasetType.fact,    #     task_id=config.task_name('download-shopify-4'),    #     gcp_conn_id='google_cloud_default',    #     jar=config.remote_repo() + 'com/umusic/data/datalake/elt/shopify/shopify-ingestion/{version}/shopify-ingestion-{version}-dataflow.jar'.format(    #         version=config.get('version')),    #     job_class='com.umusic.datalake.elt.shopify.ingestion.dataflow.Scraper',    #     options={    #         'labels': config.labels(),    #         'inputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/batch1/next_batch4/*',    #         'outputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/batch4/',    #         'startDate': '{{ds}}',    #         'endDate': '{{tomorrow_ds}}',    #         'workerMachineType': 'n1-standard-2',    #         'numWorkers': '3',    #         'maxNumWorkers': '6',    #         'vaultUrl': config.get("central_vault_host"),    #         'vaultRole': config.get("shopify_vault_role"),    #         'vaultShopifyPath': config.get('shopify_vault_path'),    #         'apisToSkip': config.get('shopify_apis_to_skip'),    #         'reportPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/report/batch4/',    #         'apiVersion': "{{var.value.shopify_api_version}}",    #           'vaultServiceAccount': config.get('shopify_vault_service_account'),    #         'BQSyncFlag': config.get('batch_daily_BQSyncFlag')    #     },    #     retries=5,    #     dag=dag)    # download_batch_5 = rest_api_client(    #     dataset_type=DatasetType.fact,    #     task_id=config.task_name('download-shopify-5'),    #     gcp_conn_id='google_cloud_default',    #     jar=config.remote_repo() + 'com/umusic/data/datalake/elt/shopify/shopify-ingestion/{version}/shopify-ingestion-{version}-dataflow.jar'.format(    #     version=config.get('version')),    #     job_class='com.umusic.datalake.elt.shopify.ingestion.dataflow.Scraper',    #     options={    #         'labels': config.labels(),    #         'inputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/batch1/next_batch5/*',    #         'outputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/batch5/',    #         'startDate': '{{ds}}',    #         'endDate': '{{tomorrow_ds}}',    #         'workerMachineType': 'n1-standard-2',    #         'numWorkers': '3',    #         'maxNumWorkers': '6',    #         'vaultUrl': config.get("central_vault_host"),    #         'vaultRole': config.get("shopify_vault_role"),    #         'vaultShopifyPath': config.get('shopify_vault_path'),    #         'apisToSkip': config.get('shopify_apis_to_skip'),    #         'reportPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/report/batch5/',    #         'apiVersion': "{{var.value.shopify_api_version}}",    #           'vaultServiceAccount': config.get('shopify_vault_service_account'),    #         'BQSyncFlag': config.get('batch_daily_BQSyncFlag')    #     },    #     retries=5,    #     dag=dag)    # download_product_metadata = rest_api_client(    #     dataset_type=DatasetType.fact,    #     task_id=config.task_name('download-shopify-product-metadata'),    #     gcp_conn_id='google_cloud_default',    #     jar=config.remote_repo() + 'com/umusic/data/datalake/elt/shopify/shopify-ingestion/{version}/shopify-ingestion-{version}-dataflow.jar'.format(    #         version=config.get('version')),    #     job_class='com.umusic.datalake.elt.shopify.ingestion.dataflow.ProductMetadataScraper',    #     options={    #         'labels': config.labels(),    #         'inputPath': '',    #         'outputPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/metadata/',    #         'reportDate': '{{ds}}',    #         'workerMachineType': 'n1-standard-1',    #         'numWorkers': '25',    #         'maxNumWorkers': '50',    #         'vaultUrl': config.get("central_vault_host"),    #         'vaultRole': config.get("shopify_vault_role"),    #         'vaultShopifyPath': config.get('shopify_vault_path'),    #         'shopsType': "nonvinyl",    #         'apisToSkip': config.get('shopify_apis_to_skip'),    #         'reportPath': config.get('gs_raw_bucket') + 'source/shopify.batch.v2_0/report_date={{ds_nodash}}/metadata/report/',    #         'apiVersion': "{{var.value.shopify_api_version}}",    #         'vaultServiceAccount': config.get('shopify_vault_service_account')    #     },    #     retries=5,    #     dag=dag)    init_orders_count = UMGBigQueryOperator(        task_id=config.task_name('init_orders_count'),        sql='sql/batch/init_orders_count.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_collects = UMGBigQueryOperator(        task_id=config.task_name('init_collects'),        sql='sql/batch/init_collects.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    # init_customers = UMGBigQueryOperator(    #     task_id=config.task_name('init_customers'),    #     sql='sql/batch/init_customers.sql',    #     create_disposition='CREATE_IF_NEEDED',    #     use_legacy_sql=False,    #     params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},    #     dag=dag    # )    init_disputes = UMGBigQueryOperator(        task_id=config.task_name('init_disputes'),        sql='sql/batch/init_disputes.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_events = UMGBigQueryOperator(        task_id=config.task_name('init_events'),        sql='sql/batch/init_events.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_gift_cards = UMGBigQueryOperator(        task_id=config.task_name('init_gift_cards'),        sql='sql/batch/init_gift_cards.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_inventory_items = UMGBigQueryOperator(        task_id=config.task_name('init_inventory_items'),        sql='sql/batch/init_inventory_items.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_inventory_levels = UMGBigQueryOperator(        task_id=config.task_name('init_inventory_levels'),        sql='sql/batch/init_inventory_levels.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_locations = UMGBigQueryOperator(        task_id=config.task_name('init_locations'),        sql='sql/batch/init_locations.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_metafields = UMGBigQueryOperator(        task_id=config.task_name('init_metafields'),        sql='sql/batch/init_metafields.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_payouts = UMGBigQueryOperator(        task_id=config.task_name('init_payouts'),        sql='sql/batch/init_payouts.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_payouts_transactions = UMGBigQueryOperator(        task_id=config.task_name('init_payouts_transactions'),        sql='sql/batch/init_payout_transactions.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_price_rules = UMGBigQueryOperator(        task_id=config.task_name('init_price_rules'),        sql='sql/batch/init_price_rules.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    #init_products = UMGBigQueryOperator(    #    task_id=config.task_name('init_products'),    #    sql='sql/batch/init_products.sql',     #   create_disposition='CREATE_IF_NEEDED',      #  use_legacy_sql=False,       # params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},       # dag=dag    #)    init_smart_collection = UMGBigQueryOperator(        task_id=config.task_name('init_smart_collection'),        sql='sql/batch/init_smart_collections.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    init_custom_collection = UMGBigQueryOperator(        task_id=config.task_name('init_custom_collection'),        sql='sql/batch/init_custom_collections.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )        init_pages = UMGBigQueryOperator(        task_id=config.task_name('init_pages'),        sql='sql/batch/init_pages.sql',        create_disposition='CREATE_IF_NEEDED',        use_legacy_sql=False,        params={'bq_project': config.get('bq_project'), 'bq_dataset': 'shopify_source'},        dag=dag    )    # init_customer_metafields = UMGBigQueryOperator(    #     task_id=config.task_name('init_customer_metafields'),    #     sql='sql/batch/init_customer_metafields.sql',    #     create_disposition='CREATE_IF_NEEDED',    #     use_legacy_sql=False,    #     params={'bq_project': config.get('bq_project'), 'bq_dataset': config.get('dataset')},    #     dag=dag    # )    #    # init_collection_metafields = UMGBigQueryOperator(    #     task_id=config.task_name('init_collection_metafields'),    #     sql='sql/batch/init_collection_metafields.sql',    #     create_disposition='CREATE_IF_NEEDED',    #     use_legacy_sql=False,    #     params={'bq_project': config.get('bq_project'), 'bq_dataset': config.get('dataset')},    #     dag=dag    # )    # skip_check_load_to_bq_custo
